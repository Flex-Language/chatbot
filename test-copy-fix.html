<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Flex Syntax Highlighting - Copy Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4ecdc4;
        }

        .code-example {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            overflow-x: auto;
            margin: 12px 0;
            position: relative;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #3b82f6;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .copy-button:hover {
            background: #2563eb;
        }

        .flex-franco-keyword {
            color: #ff6b6b;
            font-weight: bold;
        }

        .flex-english-keyword {
            color: #4ecdc4;
            font-weight: bold;
        }

        .flex-safety-keyword {
            color: #ffa726;
            font-weight: bold;
            background: rgba(255, 167, 38, 0.1);
            padding: 1px 3px;
            border-radius: 3px;
        }

        .flex-string {
            color: #98c379;
        }

        .flex-comment {
            color: #7c7c7c;
            font-style: italic;
        }

        .flex-number {
            color: #d19a66;
        }

        .flex-builtin {
            color: #ab7df8;
            font-weight: 600;
        }

        .flex-literal {
            color: #e5c07b;
        }

        .clean-output {
            background: #0f1419;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            white-space: pre-wrap;
            font-family: monospace;
            color: #a8a8a8;
        }
    </style>
</head>

<body>
    <h1>🔧 Fixed Flex Syntax Highlighting - Copy Test</h1>

    <div class="test-section">
        <h2>Test: XO Game Code (Fixed)</h2>
        <p>This should now highlight properly without nested spans and copy cleanly:</p>

        <div class="code-example">
            <button class="copy-button" onclick="copyCleanCode()">Copy Clean Code</button>
            <div id="highlighted-code">
                <!-- This will be filled by JavaScript -->
            </div>
        </div>

        <h3>Clean Output Preview:</h3>
        <div class="clean-output" id="clean-output">
            <!-- This will show the clean copied code -->
        </div>
    </div>

    <script>
        // Simplified syntax highlighter for testing
        class TestSyntaxHighlighter {
            constructor() {
                this.flexSyntax = {
                    francoKeywords: {
                        control: ['lw', 'kida', 'gher', 'wla', 'aw', 'bass', 'iza'],
                        loops: ['karr', 'l7d', 'tl', 'tlma', 'tlama'],
                        functions: ['sndo2', 'sndog', 'arja3', 'yerja3', 'estd3i'],
                        variables: ['mtaghayar', 'thabit', 'mwaqat'],
                        io: ['etb3', 'da5al', 'da5l', 'awsal', 'era'],
                        types: ['rakm', 'kasr', 'klma', 'so2al', 'ghalat', 'dorg'],
                        operators: ['w', 'aw', 'mish', 'yesawi', 'akbar', 'asghar', 'zawad']
                    },
                    englishKeywords: {
                        control: ['if', 'condition', 'else', 'elif', 'or', 'only', 'when'],
                        loops: ['for', 'while', 'repeat', 'until', 'continue'],
                        functions: ['function', 'def', 'return', 'returns', 'call'],
                        variables: ['var', 'const', 'temp'],
                        io: ['print', 'input', 'output', 'send', 'read'],
                        types: ['int', 'float', 'string', 'bool', 'error', 'list'],
                        operators: ['and', 'or', 'not', 'equals', 'greater', 'less', 'plus']
                    },
                    safetyKeywords: ['safe', 'check', 'validate', 'verify', 'secure', 'aman', 'ta2akkad'],
                    literals: ['true', 'false', 'sa7', 'khata', 'tamam', 'null', 'void', 'fadi'],
                    builtinFunctions: ['sqrt', 'pow', 'max', 'min', 'len', 'size', 'join', 'split', 'scan', 'main']
                };
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            highlightFlexSyntax(code) {
                // Apply patterns in order of priority, avoiding overlaps
                let result = code;
                const placeholders = [];
                let placeholderIndex = 0;

                const patterns = [
                    // Comments (highest priority)
                    { name: 'comment', regex: /(\/\/.*?$)/gm, class: 'flex-comment' },

                    // Strings (high priority)
                    { name: 'string', regex: /"[^"]*"/g, class: 'flex-string' },

                    // Safety keywords
                    { name: 'safety', regex: new RegExp(`\\b(${this.flexSyntax.safetyKeywords.join('|')})\\b`, 'gi'), class: 'flex-safety-keyword' },

                    // Franco keywords
                    { name: 'franco', regex: new RegExp(`\\b(${Object.values(this.flexSyntax.francoKeywords).flat().join('|')})\\b`, 'g'), class: 'flex-franco-keyword' },

                    // English keywords
                    { name: 'english', regex: new RegExp(`\\b(${Object.values(this.flexSyntax.englishKeywords).flat().join('|')})\\b`, 'g'), class: 'flex-english-keyword' },

                    // Built-in functions
                    { name: 'builtin', regex: new RegExp(`\\b(${this.flexSyntax.builtinFunctions.join('|')})\\b`, 'g'), class: 'flex-builtin' },

                    // Literals
                    { name: 'literal', regex: new RegExp(`\\b(${this.flexSyntax.literals.join('|')})\\b`, 'g'), class: 'flex-literal' },

                    // Numbers
                    { name: 'number', regex: /\b\d+(\.\d+)?\b/g, class: 'flex-number' }
                ];

                patterns.forEach(pattern => {
                    let match;
                    pattern.regex.lastIndex = 0;

                    while ((match = pattern.regex.exec(result)) !== null) {
                        const placeholder = `__PLACEHOLDER_${placeholderIndex}__`;
                        const highlightedText = `<span class="${pattern.class}">${this.escapeHtml(match[0])}</span>`;

                        placeholders[placeholderIndex] = highlightedText;
                        result = result.substring(0, match.index) + placeholder + result.substring(match.index + match[0].length);

                        pattern.regex.lastIndex = match.index + placeholder.length;
                        placeholderIndex++;
                    }
                });

                // Replace placeholders with highlighted text
                placeholders.forEach((highlightedText, index) => {
                    result = result.replace(`__PLACEHOLDER_${index}__`, highlightedText);
                });

                return result;
            }

            extractCleanCode(htmlCode) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlCode;
                return tempDiv.textContent || tempDiv.innerText || '';
            }
        }

        const testCode = `// The game board represented as a list
list board = [" ", " ", " ", " ", " ", " ", " ", " ", " "]

// Current player: 1 for X, 2 for O
int currentPlayer = 1  

// Function to display the current state of the board
fun printBoard() {
    // Print the board in a formatted manner
    print("{board[0]} | {board[1]} | {board[2]}")
    print("---+---+---")
    print("{board[3]} | {board[4]} | {board[5]}")
    print("---+---+---")
    print("{board[6]} | {board[7]} | {board[8]}")
}

// Function to check if a player has won
fun checkWin(player, mark) {
    // Check rows for a win
    if (board[0] == mark and board[1] == mark and board[2] == mark) return true
    if (board[3] == mark and board[4] == mark and board[5] == mark) return true
    if (board[6] == mark and board[7] == mark and board[8] == mark) return true
    return false
}

// Main game loop
fun main() {
    int move
    string mark = "X"
    
    while(true) {
        printBoard()
        print("Player, enter your move (1-9):")
        move = scan()
        
        if (move < 1 or move > 9) {
            print("Invalid move. Try again.")
            continue
        }
        
        board[move - 1] = mark
        
        if (checkWin(currentPlayer, mark)) {
            printBoard()
            print("Player wins!")
            break
        }
        
        // Switch player
        if (mark == "X") {
            mark = "O"
        } else {
            mark = "X"
        }
    }
}

main()`;

        const highlighter = new TestSyntaxHighlighter();
        let globalHighlightedCode = '';

        function initTest() {
            const highlighted = highlighter.highlightFlexSyntax(testCode);
            globalHighlightedCode = highlighted;

            document.getElementById('highlighted-code').innerHTML = highlighted;

            // Show clean version
            const clean = highlighter.extractCleanCode(highlighted);
            document.getElementById('clean-output').textContent = clean;

            console.log('Original code length:', testCode.length);
            console.log('Highlighted code length:', highlighted.length);
            console.log('Clean extracted length:', clean.length);
            console.log('Clean matches original:', clean === testCode);
        }

        async function copyCleanCode() {
            const clean = highlighter.extractCleanCode(globalHighlightedCode);

            try {
                await navigator.clipboard.writeText(clean);
                const button = document.querySelector('.copy-button');
                const originalText = button.textContent;
                button.textContent = '✅ Copied!';
                button.style.background = '#10b981';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#3b82f6';
                }, 1500);

                console.log('✅ Clean code copied successfully!');
                console.log('Copied text:', clean);
            } catch (err) {
                console.error('❌ Failed to copy:', err);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initTest);
    </script>
</body>

</html>